@using Booker.WebUI.Helpers
@using Booker.Common
@using Booker.WebUI.Extensions
@model Booker.WebUI.Models.ApprovedInvoices.ViewApprovedInvoiceModel

@{
    ViewBag.Title = "Approved Invoice";
    ViewBag.MenuSection = "invoices-menu";
}
<div class="main-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12">
                <h2>Approved Invoice</h2>

                <div class="invoice-approval">

                    @if (Model.IsDocumentMissing == false)
                    {
                        <div class="doc-view">
                            <iframe src="@Url.Action("InvoiceDocument", "SubmittedInvoices", new { id = Model.InvoiceHeader.Id })" scrolling="no" seamless="true"></iframe>
                        </div>
                    }
                    else
                    {
                        <div class="doc-view default-bg">
                            <h3 class="warning-text">Invoice Document Not Found</h3>
                            <p>
                                The invoice document could not be found. It may be that the invoice was approved in an earlier version of the application. The invoice is probably contained
                                in one of theHistorical Batches. You should check historical batches around the invoice approval date of @Html.DateString(Model.DateApproved.ToShortDateString()).
                            </p>
                        </div>
                    }

                    <div class="inv-details">

                        <div id="info-tables">

                            <table id="invoice-table" class="horiz-table">
                                <tbody>
                                    <tr>
                                        <th class="right-text w33">Order Ref</th>
                                        <td>@Model.WorkOrder.WorkOrderRef</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Order Value ($)</th>
                                        <td>@Html.DecimalToCurrencyString(Model.WorkOrder.WorkOrderValue)</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Job Ref</th>
                                        <td>@Model.WorkOrder.JobRef</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Store</th>
                                        <td>@Html.TextOrEmptyString(Model.WorkOrder.SiteName)</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Job Date</th>
                                        <td>@Html.TextOrEmptyString(Model.WorkOrder.AlarmDate.ToCurrentCultureDateTime())</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Inv Num</th>
                                        <td>@Model.InvoiceHeader.InvoiceNumber</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Inv Date</th>
                                        <td>@Model.InvoiceHeader.InvoiceDate</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Supplier</th>
                                        <td>@Model.Supplier.Name</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Net ($)</th>
                                        <td>@Html.DecimalToCurrencyString(Model.InvoiceHeader.NetAmount)</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Tax ($)</th>
                                        <td>@Html.DecimalToCurrencyString(Model.InvoiceHeader.TaxAmount)</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Gross ($)</th>
                                        <td>@Html.DecimalToCurrencyString(Model.InvoiceHeader.GrossAmount)</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Approved On</th>
                                        <td>@Html.TextOrEmptyString(Model.DateApproved.ToCurrentCultureDateTime())</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Approver 1</th>
                                        <td>@Model.FirstApproverName</td>
                                    </tr>
                                    <tr>
                                        <th class="right-text w33">Approver 2</th>
                                        <td>@Model.SecondApproverName</td>
                                    </tr>
                                </tbody>
                            </table>

                        </div>

                        <p id="button-strip" class="clearall default-top-margin">
                            <a id="view-invoice-lines" class="float-right" href="#InvoiceLines">View Invoice Lines</a>
                        </p>

                    </div>
                </div>

                <div id="invoice-lines">

                    <a id="InvoiceLines"></a>
                    <table class="default-top-margin">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Type</th>
                                <th class="right-text">Quantity</th>
                                <th class="right-text">Unit Price ($)</th>
                                <th class="right-text">Value ($)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var invoiceLine in Model.InvoiceLines)
                            {
                                @Html.Partial("_InvoiceLineTableRow", invoiceLine)
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="right-text">Total Value ($):</td>
                                <td class="right-text">@Html.DecimalToCurrencyString(Model.TotalInvoiceLineValue)</td>
                            </tr>
                        </tfoot>
                    </table>

                </div>

                <div id="flb-container" class="default-top-margin">

                    <a id="flb"></a>
                    <table id="flb-table" class="horiz-table">
                        <tbody>
                            <tr>
                                <th class="right-text w33">Order Ref</th>
                                <td>@Model.WorkOrder.WorkOrderRef</td>
                            </tr>
                            <tr>
                                <th class="right-text w33">Job Ref</th>
                                <td>@Model.WorkOrder.JobRef</td>
                            </tr>
                            <tr>
                                <th class="right-text w33">Store</th>
                                <td>@Html.TextOrEmptyString(Model.WorkOrder.SiteName)</td>
                            </tr>
                            <tr>
                                <th class="right-text w33">Job Date</th>
                                <td>@Html.TextOrEmptyString(Model.WorkOrder.AlarmDate.ToCurrentCultureDateTime())</td>
                            </tr>
                            <tr>
                                <th class="right-text w33">First Arrival Date/Time</th>
                                <td>@Model.OnSiteTimeArrival</td>
                            </tr>
                            <tr>
                                <th class="right-text w33">Total Onsite Hours</th>
                                <td><a href="#ClosedownEvents" id="view-closedown-events">@Model.OnSiteTimeDuration</a></td>
                            </tr>
                            @foreach (var gasUsage in Model.GasUsageDetails)
                            {
                                <tr>
                                    <th class="right-text w33">Leakage code</th>
                                    <td>@gasUsage.LeakageType</td>
                                </tr>
                                <tr>
                                    <th class="right-text w33">Gas type</th>
                                    <td>@gasUsage.GasType</td>
                                </tr>
                                <tr>
                                    <th class="right-text w33">Gas quantity</th>
                                    <td>@gasUsage.GasUsage</td>
                                </tr>
                            }
                            @foreach (var cert in Model.Certificates)
                            {
                                <tr>
                                    <th class="right-text w33">@cert.CertificateType.Description</th>
                                    <td>@cert.CertificateNumber</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div id="closedown-events">
                    <a id="ClosedownEvents"></a>
                    <table class="default-top-margin">
                        <thead>
                            <tr>
                                <th>Arrival Date/Time</th>
                                <th>Onsite Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ce in Model.OnSiteTimeRecords)
                            {
                                <tr>
                                    <td>@ce.OnsiteSATime.ToCurrentCultureDateTime()</td>
                                    <td>@ce.Hours.ToHoursAndMinutes()</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div id="verification-container" class="default-top-margin">

                    <a id="verification"></a>
                    <table id="verification-table" class="horiz-table">
                        <thead>
                            <tr>
                                <th colspan="4">Verifications by Helpdesk are shown in blue</th>
                            </tr>
                            <tr>
                                <th>Ref</th>
                                <th>Arrival</th>
                                <th>Verification</th>
                                <th>Complete</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var sv in Model.StoreVerifications)
                            {
                                <tr @{ if (sv.TimeStampTypeId == HelpDeskFaultTimeType.NoStoreVerification) { @: class="helpdesk-verification"
                                                                                                } }>
                                    <td>@sv.ContractorRef</td>
                                    <td>@Html.DateAndTimeString(sv.OnsiteSATime)</td>
                                    <td>@Html.DateAndTimeString(sv.CreatedDateSATime)</td>
                                    <td>@Html.BoolToString(sv.IsJobComplete)</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>

                <div class="default-top-margin clear">
                    <hr />
                    @Html.ActionLink("<< Back to Approved Invoices", "Index", "SubmittedInvoices")
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/invoiceapproval")
}
